# 初始化数据库说明

## 问题说明

如果启动容器时遇到以下错误：

```
ERROR: 数据库建表失败:
(sqlite3.OperationalError) unable to open database file
```

说明缺少 `wali.db` 数据库文件。

---

## 解决方案

### 方案1：使用完整分发包（推荐）

从完整分发包中获取已配置好的数据库文件：

```
瓦力魔音工坊-分发包/
└── 后端/
    ├── wali.db          ← 复制这个文件
    ├── checkpoints/     ← 复制这个目录
    └── docker-compose.yml
```

将 `wali.db` 和 `checkpoints/` 复制到你的 backend 目录。

---

### 方案2：从备份恢复

如果你有之前的备份：

```bash
# 复制备份的数据库
cp /path/to/backup/wali.db ./backend/wali.db

# 复制备份的模型文件
cp -r /path/to/backup/checkpoints ./backend/checkpoints
```

---

### 方案3：创建空数据库（不推荐）

如果没有分发包或备份，需要创建空数据库并手动配置：

#### 步骤1：创建空数据库

```bash
cd backend
touch wali.db
```

#### 步骤2：启动容器

容器会自动创建数据库表结构。

#### 步骤3：手动配置（必需）

启动后需要通过前端界面配置：

1. **创建项目**
   - 打开前端：http://localhost:8300
   - 创建新项目

2. **上传音色**
   - 进入"音色管理"
   - 上传参考音频
   - 配置音色名称和描述

3. **创建角色**
   - 进入项目详情
   - 创建角色并绑定音色

4. **配置TTS服务**
   - 确保本地TTS服务正常运行
   - 或配置远程TTS服务

---

## 数据库文件说明

### wali.db 包含的数据

- **项目配置**：项目名称、描述、LLM配置
- **角色配置**：角色名称、音色绑定
- **音色库**：音色名称、描述、参考音频路径
- **章节数据**：章节内容、配音记录
- **系统配置**：TTS服务配置、情绪强度映射

### 文件位置

```
backend/
├── wali.db              ← 数据库文件必须在这里
├── docker-compose.yml
└── checkpoints/
```

### 文件权限

确保文件可读写：

```bash
chmod 644 wali.db
```

---

## 模型文件说明

### checkpoints/ 目录结构

```
checkpoints/
├── gpt.pth              # GPT模型（约3.4GB）
├── s2mel.pth            # S2Mel模型（约1.2GB）
├── qwen0.6bemo4-merge/  # Qwen情绪模型
│   ├── config.json
│   ├── model.safetensors
│   └── ...
└── ...
```

### 如何获取模型文件

1. **从分发包获取**（推荐）
   - 完整分发包包含所有模型文件
   - 直接复制 `checkpoints/` 目录

2. **从官方下载**
   - 需要单独下载各个模型
   - 放置到正确的目录结构

---

## 完整启动检查清单

启动前确认以下文件存在：

- [ ] `backend/wali.db` - 数据库文件
- [ ] `backend/checkpoints/gpt.pth` - GPT模型
- [ ] `backend/checkpoints/s2mel.pth` - S2Mel模型
- [ ] `backend/checkpoints/qwen0.6bemo4-merge/` - Qwen模型目录
- [ ] `backend/docker-compose.yml` - Docker配置

如果以上文件都存在，执行：

```bash
cd backend
docker-compose up -d
```

---

## 常见问题

### Q1: 为什么不能自动创建数据库？

A: 数据库需要初始配置数据（项目、角色、音色等），空数据库无法直接使用。

### Q2: 可以使用其他人的数据库吗？

A: 可以，但需要确保：
- 音色文件路径匹配
- 模型文件完整
- 项目配置适合你的需求

### Q3: 数据库损坏怎么办？

A: 
1. 停止容器：`docker-compose down`
2. 备份当前数据库：`cp wali.db wali.db.backup`
3. 从备份恢复或使用新的数据库
4. 重新启动：`docker-compose up -d`

### Q4: 如何备份数据？

A: 定期备份以下文件和目录：
```bash
# 备份数据库
cp wali.db /backup/wali.db.$(date +%Y%m%d)

# 备份音色文件
cp -r voices /backup/voices.$(date +%Y%m%d)

# 备份输出文件
cp -r outputs /backup/outputs.$(date +%Y%m%d)
```

---

## 技术支持

如果遇到问题，请提供以下信息：

1. 错误日志：`docker-compose logs`
2. 文件列表：`ls -lh backend/`
3. Docker版本：`docker --version`
4. 系统信息：Windows/Linux/Mac版本
